#!/usr/bin/env node

const mq = require("../dist/mq.js");
const program = require("commander");

program
  .version("1.2.0")
  .arguments("<routingKey>")
  .description("Remote procedure call.")
  .option("-d, --data <json>", "payload data (json string)")
  .option("-t, --ttl <milliseconds>", "timeout in milliseconds")
  .option("-s, --silent", "silent mode (don't output anything)")
  .option("-r, --repeat <N>", "repreat the request N times")
  .option("-x, --random", "generate random payload data")
  .action(function(routingKey) {
    const data = program.data ? JSON.parse(program.data) : {};
    const ttl = program.ttl ? parseInt(program.ttl) : undefined;
    const silent = program.silent ? true : false;
    const repeat = program.repeat ? parseInt(program.repeat) : 1;
    if (routingKey) {
      const client = new mq.client.Client();
      Promise.all(Array.from(Array(repeat).keys()).map((n) => {
        const payload = program.random ? Math.random() : data;
        return client.rpc(routingKey, payload, {})
          .then((msg) => { if (!silent) console.log(msg); })
          .catch((err) => { if (!silent) console.error(err); });
      }))
      .then(() => process.exit(0))
      .catch(() => process.exit(1));
    } else {
      program.outputHelp();
    }
  });

program.parse(process.argv);

if (!process.argv.slice(2).length) {
  program.outputHelp();
}
