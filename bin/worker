#!/usr/bin/env node --napi-modules

const mq = require("../dist/server.js");
const program = require("commander");

program
  .version("1.2.0")
  .arguments("<routingKey>")
  .description("auto reply-worker.")
  .option("-d, --data <json>", "response data (json string)")
  .option("-s, --silent", "silent mode (don't output anything)")
  .option("-w, --wait <seconds>", "seconds to wait before sending response")
  .action(function(routingKey) {
    const payload = program.data ? JSON.parse(program.data) : undefined;
    const wait = program.wait ? parseInt(program.wait) : 0;
    if (routingKey) {
      mq.worker(routingKey, (message, headers) => {
        console.log(message, headers);
        return new Promise((resolve, reject) => {
          setTimeout(() => {
            resolve(payload ? payload : message);
          }, wait * 1000);
        });
      });
      mq.startServer();
    } else {
      program.outputHelp();
    }
  });

program.parse(process.argv);

if (!process.argv.slice(2).length) {
  program.outputHelp();
}

if (program.silent) {
  mq.setLogger(() => {});
}
